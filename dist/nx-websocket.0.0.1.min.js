(function(){"use strict";var a,b,c=[].slice;b=angular.module("nx"),b.provider("nxWebsocket",a=function(){var a,b,d,e,f,g,h,i,j,k;return i={},k=function(){return Math.random()},f=function(a){return"object"==typeof a&&"function"==typeof a.$emit},b={uri:"ws://localhost",protocol:void 0,timeout:500,socket:{emit:"nxSocket::response",connect:"nxSocket::connect",close:"nxSocket::close",broadcast:"nxSocket::broadcast"}},this.setUri=function(a){return b.uri=a},e=function(a,b){return angular.forEach(b,function(b,c){return a.__defineGetter__(c,function(){return b.call(a)})})},g=function(){function a(){}return a}(),h=function(){function a(a){this.socket=null,this.ready=[],this.responses={},this.subscribtions={},this.connected=!1,this.scopes=[],a=angular.extend({},b,a),e(this,{uri:function(){return a.uri},protocol:function(){return a.protocol},options:function(){return a}})}return a.prototype._send=function(a,b){var c;return c={uuid:a.uuid||k(),gid:a.gid||k(),head:a,body:b},this._connect(function(a){return a.send(JSON.stringify(c))})},a.prototype.send=function(a,b){return angular.isUndefined(b)&&(b=a,a={}),this._send(a,b)},a.prototype.request=function(a,b,c){var d,e;if("function"!=typeof a&&b||(c=b,b=a,a=null),c||(c=this.options.timeout),a||(a=null),"function"!=typeof b&&!f(b))throw new Error("No method to respond");return e=k(),this.responses[e]=b,d={response:e},this.send(d,a)},a.prototype.subscribe=function(a,b){var c=this;if(!f(b))throw new Error("No $scope for subscribtion");return angular.isArray(a)||(a=[a]),angular.forEach(a,function(a){return c.subscribtions.hasOwnProperty(a)?c.subscribtions[a].push(b):c.subscribtions[a]=[b]}),this.send({pubsub:{subscribe:a}},null)},a.prototype.unsubscribe=function(a,b){return this.subscribtions.hasOwnProperty(a)?(this.subscribtions[a].filter(function(a){return a.$id===b.$id}),this.send({pubsub:{unsubscribe:a}},null)):void 0},a.prototype._emit=function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],angular.forEach(this.scopes,function(b){return b.$emit.apply(b,a),b.$digest()})},a.prototype._handleResponse=function(a){var b,c,d,e=this;return c=a.head,b=a.body,c.response?(d=this.responses[c.response],"function"==typeof d?d.call(this,b):d.$apply(function(){return d.$emit(e.options.socket.emit,b)})):this._emit(this.options.socket.broadcast,b)},a.prototype._close=function(a){return this.connected=!1,this.socket=null,this._emit(this.options.socket.close,a)},a.prototype._connect=function(a){var b,c=this;return this.socket||(b=new WebSocket(this.options.uri,this.options.protocol),b.onopen=function(){return c.connected=!0,c._emit(c.options.socket.connect),angular.forEach(c.ready,function(a){return a.call(b,b)})},b.onerror=function(a){return c._close(a)},b.onclose=function(){return c._close()},b.onmessage=function(a){var b;return a.hasOwnProperty("data")?(b=JSON.parse(a.data),c._handleResponse(b)):new Error("Missing packet content")},this.socket=b),1===this.socket.readyState?a.call(this.socket,this.socket):this.ready.push(a)},a}(),d=function(a,b){return"string"==typeof a&&(a={uri:a}),b&&(a.protocol=b),new h(a)},j=null,a={connect:d,open:d,send:function(){var b;return b=1<=arguments.length?c.call(arguments,0):[],a.socket.send.apply(j,b)},request:function(){var b;return b=1<=arguments.length?c.call(arguments,0):[],a.socket.request.apply(j,b)},publish:function(){var b;return b=1<=arguments.length?c.call(arguments,0):[],a.socket.publish.apply(j,b)},subscribe:function(){var b;return b=1<=arguments.length?c.call(arguments,0):[],a.socket.subscribe.apply(j,b)},unsubscribe:function(){var b;return b=1<=arguments.length?c.call(arguments,0):[],a.socket.unsubscribe.apply(j,b)}},a.__defineGetter__("connected",function(){return a.socket.connected}),a.__defineGetter__("socket",function(){return j?j:j=d(b.uri,b.protocol)}),this.$get=function(){return a}})}).call(this);