(function(){"use strict";var a,b,c=[].slice;b=angular.module("nx"),b.provider("nxWebsocket",a=function(){var a,b,d,e,f,g;return f={},g=function(){return Math.random()},d=function(a){return"object"==typeof a&&"function"==typeof a.$emit},b={uri:"ws://localhost",header:[],timeout:500,socket:{emit:"nxSocket::response"}},this.setUri=function(a){return b.uri=a},a=function(a,b){return function(){var d;return d=1<=arguments.length?c.call(arguments,0):[],a[b].apply(a,d)}},e=function(){function a(a,b){this.uri=a,this.header=b,this.socket=null,this.ready=[],this.responses={},this.subscribtions={}}return a.prototype.send=function(a){return null==a&&(a={}),a.uuid=a.uuid||g(),this._connect(function(b){return b.send(JSON.stringify(a))})},a.prototype.request=function(a,c,e){var f;if("function"!=typeof a&&c||(e=c,c=a,a=null),e||(e=b.timeout),a||(a=null),"function"!=typeof c&&!d(c))throw new Error("No method to respond");return f=g(),this.responses[f]=c,this.send({response:f,data:a})},a.prototype.subscribe=function(a,b){var c=this;if(!d(b))throw new Error("No $scope for subscribtion");return angular.isArray(a)||(a=[a]),angular.forEach(a,function(a){return c.subscribtions.hasOwnProperty(a)?c.subscribtions[a].push(b):c.subscribtions[a]=[b]}),this.send({pubsub:{subscribe:a}})},a.prototype.unsubscribe=function(a,b){return this.subscribtions.hasOwnProperty(a)?(this.subscribtions[a].filter(function(a){return a.$id===b.$id}),this.send({pubsub:{unsubscribe:a}})):void 0},a.prototype._handleResponse=function(a){var c;return c=this.responses[a.response],"function"==typeof c?c.call(this,a.data):c.$apply(function(){return c.$emit(b.socket.emit,a.data)})},a.prototype._connect=function(a){var b,c=this;return this.socket||(b=new WebSocket(this.uri,this.header),b.onopen=function(){return angular.forEach(c.ready,function(a){return a.call(b,b)})},b.onerror=function(){},b.onclose=function(){},b.onmessage=function(a){var b;return a.hasOwnProperty("data")?(b=JSON.parse(a.data),b.hasOwnProperty("data")?b.response?c._handleResponse(b):void 0:void 0):new Error("Missing packet content")},this.socket=b),1===this.socket.readyState?a.call(this.socket,this.socket):this.ready.push(a)},a}(),this.$get=function(){var c,d;return c=function(a,b){return new e(a,b)},d=c(b.uri,b.header),{socket:d,open:c,connect:c,send:a(d,"send"),request:a(d,"request"),publish:a(d,"publish"),subscribe:a(d,"subscribe"),unsubscribe:a(d,"unsubscribe")}}})}).call(this);